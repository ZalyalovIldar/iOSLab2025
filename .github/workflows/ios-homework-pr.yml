name: iOS Homework PR checks (SwiftLint + reviewdog)

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.swift'
      - 'Package.swift'
      - '**/*.xcodeproj/**'
      - '**/*.xcworkspace/**'

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_reviewdog:
    name: SwiftLint + reviewdog (inline PR comments)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/realm/swiftlint:latest
    steps:
      # 0) Устанавливаем git + curl в контейнер ДО checkout, чтобы появился .git
      - name: Install git & curl in container
        run: |
          set -e
          if command -v apt-get >/dev/null; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git curl ca-certificates
            update-ca-certificates || true
          elif command -v apk >/dev/null; then
            apk add --no-cache git curl ca-certificates
            update-ca-certificates || true
          elif command -v dnf >/dev/null; then
            dnf -y install git curl ca-certificates
          else
            echo "Unknown base image. Install git and curl manually." >&2
            exit 1
          fi
          git --version
          curl --version

      # 1) Чекаут теперь сделается через git и создаст .git
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # (Опционально) фикс предупреждения про dubious ownership внутри контейнера
      - name: Mark workspace as safe for git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # 2) Конфиг SwiftLint для CI — создаём на лету (reporter=checkstyle для reviewdog)
      - name: Generate SwiftLint CI config
        run: |
          cat > .swiftlint-ci.yml <<'YML'
          reporter: checkstyle
          strict: true
          only_rules:
            - attributes
            - closure_spacing
            - colon
            - comma
            - control_statement
            - force_cast
            - force_try
            - force_unwrapping
            - identifier_name
            - opening_brace
            - operator_usage_whitespace
            - redundant_optional_initialization
            - return_arrow_whitespace
            - statement_position
            - trailing_newline
            - trailing_semicolon
            - type_name
            - vertical_whitespace
          YML

      # 3) reviewdog (прибит к конкретному коммиту)
      - name: Setup reviewdog
        uses: reviewdog/action-setup@d8edfce3dd5e1ec6978745e801f9c50b5ef80252 # v1.4.0

      # 4) Выбираем режим: review для своих PR, checks для форков
      - name: Choose reviewdog reporter
        run: |
          if [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            echo "REPORTER=github-pr-check" >> $GITHUB_ENV
          else
            echo "REPORTER=github-pr-review" >> $GITHUB_ENV
          fi

      # 5) Линт + reviewdog
      - name: Run SwiftLint through reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e
          swiftlint lint --config .swiftlint-ci.yml --strict --reporter checkstyle \
            | reviewdog -f=checkstyle -name="SwiftLint" \
                -reporter="${REPORTER}" \
                -filter-mode=added \
                -level=warning \
                -fail-on-error=true
